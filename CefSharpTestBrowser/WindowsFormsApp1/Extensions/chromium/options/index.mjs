var O="attesters_by_issuer_key";var E={SERVICE_WORKER_MODE:"serviceWorkerMode",ATTESTERS:"attesters"},i={},R=o=>o.split(/[\n,]+/).filter(e=>{try{return new URL(e),!0}catch{return!1}});function f(o){return new Promise(e=>o.get(Object.values(E),async t=>{if(Object.entries(t).length<2){await y(o);let r=S();e({attesters:r.attesters.join(`
`),serviceWorkerMode:r.serviceWorkerMode})}else{let r=t;i={serviceWorkerMode:r.serviceWorkerMode,attesters:R(r.attesters)},e(r)}}))}function S(){return i}var M=async o=>{let e=new Map,{attesters:t,serviceWorkerMode:r}=S(),s=w(r);for(let a of t){let m=Date.now(),g=await fetch(`${a}/v1/private-token-issuer-directory`);if(!g.ok){s.log(`"${a}" issuer keys not available, attester will not be used.`);return}let v=await g.json();for(let{"token-keys":L}of Object.values(v))for(let l of L){let p=l["not-before"];!p||p>m||e.set(l["token-key"],a)}o.set({[O]:Object.fromEntries(e)})}s.info("Attester lookup by Issuer key populated")};async function c(o,e,t){switch(e){case"attesters":i[e]=R(t),await M(o);break;case"serviceWorkerMode":Object.values(n).map(r=>r).includes(t)&&(i[e]=t)}return o.set({[e]:t})}async function y(o){let e={serviceWorkerMode:n.PRODUCTION,attesters:["https://pp-attester-turnstile.research.cloudflare.com","https://pp-attester-turnstile-dev.research.cloudflare.com"]};await c(o,"serviceWorkerMode",e.serviceWorkerMode),await c(o,"attesters",e.attesters.join(`
`))}var n={PRODUCTION:"production",DEVELOPMENT:"development",DEMO:"demo"};var u=class{constructor(){this.info=(...e)=>{console.info(...e)};this.error=(...e)=>{console.error(...e)};this.debug=(...e)=>{console.debug(...e)};this.warn=(...e)=>{console.warn(...e)};this.log=(...e)=>{console.log(...e)}}},d=class o extends u{constructor(t){super();this.mode=t;this.info=(...t)=>{o.ALLOWED_CALLS.INFO.includes(this.mode)&&console.info(...t)};this.error=(...t)=>{o.ALLOWED_CALLS.ERROR.includes(this.mode)&&console.error(...t)};this.debug=(...t)=>{o.ALLOWED_CALLS.DEBUG.includes(this.mode)&&console.debug(...t)};this.warn=(...t)=>{o.ALLOWED_CALLS.WARN.includes(this.mode)&&console.warn(...t)};this.log=(...t)=>{o.ALLOWED_CALLS.LOG.includes(this.mode)&&console.log(...t)}}static{this.ALLOWED_CALLS={INFO:[n.DEVELOPMENT],ERROR:[n.DEMO,n.DEVELOPMENT,n.PRODUCTION],DEBUG:[n.DEVELOPMENT],WARN:[n.DEVELOPMENT],LOG:[n.DEMO,n.DEVELOPMENT,n.PRODUCTION]}}};function w(o){return new d(o)}var k=typeof browser<"u"?browser.storage.local:chrome.storage.local,D=async()=>{let o=await f(k);for(let e in o){let t=document.getElementById(e);t.value=o[e],t.addEventListener("change",r=>{let s=r.target;Object.values(E).includes(s.id)&&c(k,s.id,s.value.trim())})}for(let e of[...document.getElementsByTagName("a")])e.addEventListener("click",t=>{t.preventDefault(),chrome.tabs.create({url:e.href})})};document.addEventListener("DOMContentLoaded",D);
